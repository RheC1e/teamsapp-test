# Teams 應用程式疑難排解

## 🔴 問題 1: 應用程式狀態「已封鎖」

### 原因
Teams 應用程式可能因為以下原因被封鎖：
- 應用程式有錯誤
- 需要管理員審核
- 應用程式設定不正確

### 解決步驟

1. **檢查應用程式狀態**
   - 前往 Teams 管理中心
   - 找到「Teams SSO 測試」應用程式
   - 查看「應用程式狀態」

2. **解除封鎖**
   - 點擊應用程式名稱進入詳細頁面
   - 如果狀態是「已封鎖」，點擊「啟用」或「解除封鎖」
   - 或點擊「編輯可用性」設定允許使用的使用者/群組

3. **檢查應用程式設定**
   - 確認 manifest.json 中的設定正確
   - 確認 URL 可以正常訪問
   - 確認沒有錯誤訊息

### 如果無法解除封鎖

1. **刪除並重新上傳**
   - 在 Teams 管理中心刪除應用程式
   - 使用最新的 ZIP 檔案重新上傳
   - 確認版本號已更新（1.0.1）

2. **檢查權限**
   - 確認您有管理 Teams 應用程式的權限
   - 可能需要全域管理員權限

---

## 🔴 問題 2: redirect_in_iframe 錯誤

### 原因
- Teams 應用程式在 iframe 中執行
- MSAL 的 `loginRedirect` 在 iframe 中不支援
- 必須使用 `loginPopup`

### 已修復
- ✅ 已新增 `authenticateWithMSALPopup()` 函數
- ✅ 自動偵測 iframe 環境
- ✅ 在 iframe 中自動使用 Popup 登入

### 如果仍然出現錯誤

1. **確認已重新部署**
   - 檢查 Vercel 是否已重新部署
   - 確認使用的是最新版本的程式碼

2. **清除快取**
   - 在 Teams 中重新載入應用程式
   - 或清除瀏覽器快取

3. **檢查程式碼**
   - 確認 `scripts/main.js` 中有 `authenticateWithMSALPopup()` 函數
   - 確認在 Teams 環境中會調用此函數

---

## 📋 檢查清單

### 應用程式上傳前
- [ ] manifest.json 版本號已更新（1.0.1）
- [ ] manifest.json 中的 URL 正確
- [ ] 圖示檔案存在（icon-color.png, icon-outline.png）
- [ ] ZIP 檔案包含所有必要檔案

### 應用程式上傳後
- [ ] 應用程式狀態為「已啟用」或「可用」
- [ ] 可以正常開啟應用程式
- [ ] 沒有錯誤訊息

### 登入測試
- [ ] SSO 登入成功，或
- [ ] Popup 登入成功（允許彈出視窗）
- [ ] 顯示使用者資訊

---

## 🆘 如果問題持續

### 檢查項目

1. **Vercel 部署**
   - 確認 https://teams-sso-test-rho.vercel.app 可以正常訪問
   - 確認沒有錯誤訊息

2. **Azure Portal 設定**
   - 確認 Application ID URI 正確
   - 確認 Redirect URI 已新增
   - 確認 API 權限已授與

3. **Teams 管理中心**
   - 確認應用程式狀態
   - 確認應用程式已正確安裝
   - 檢查是否有錯誤日誌

### 需要協助時提供

1. Teams 管理中心顯示的錯誤訊息
2. 瀏覽器控制台的錯誤訊息
3. Vercel 部署狀態
4. Azure Portal 中的應用程式設定

---

## 💡 快速修復

### 如果應用程式被封鎖

1. 前往 Teams 管理中心
2. 找到「Teams SSO 測試」
3. 點擊「編輯可用性」
4. 設定為「所有人」或特定群組
5. 點擊「啟用」或「解除封鎖」

### 如果仍然有 redirect 錯誤

1. 確認 Vercel 已重新部署（檢查部署時間）
2. 在 Teams 中重新載入應用程式
3. 如果使用 Popup，請允許彈出視窗
4. 檢查瀏覽器控制台的錯誤訊息

