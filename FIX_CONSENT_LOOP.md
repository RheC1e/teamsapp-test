# 修復權限要求死循環和桌面版錯誤

## 🔴 問題描述

### 問題 1：桌面版錯誤
- **錯誤訊息：** "The operation attempted is invalid."
- **錯誤代碼：** 通常是因為 Azure Portal 設定不完整

### 問題 2：網頁版死循環
- 點擊「繼續」後，頁面重新整理
- 又回到權限要求對話框
- 無限循環

## ✅ 解決方案

這兩個問題都是因為 **Azure Portal 中的應用程式設定不完整**。必須完成以下設定：

### 步驟 1：設定應用程式識別碼 URI

1. **登入 Azure Portal**
   - 前往：https://portal.azure.com
   - 使用管理員帳號登入

2. **找到應用程式**
   - Azure Active Directory > 應用程式註冊
   - 搜尋：`33abd69a-d012-498a-bddb-8608cbf10c2d`
   - 或搜尋應用程式名稱

3. **設定應用程式識別碼 URI**
   - 點擊左側選單的「**公開 API**」
   - 如果「應用程式識別碼 URI」是空的，點擊「**設定**」
   - 輸入：`api://teams-sso-test-rho.vercel.app/33abd69a-d012-498a-bddb-8608cbf10c2d`
   - 點擊「**儲存**」

### 步驟 2：新增範圍（Scope）

1. **在「公開 API」頁面中**
   - 找到「**範圍**」區塊
   - 點擊「**新增範圍**」

2. **填寫範圍資訊**
   - **範圍名稱：** `access_as_user`
   - **誰可以同意：** 管理員和使用者
   - **管理員同意顯示名稱：** `Teams 可以以使用者身分存取應用程式`
   - **管理員同意描述：** `允許 Teams 以登入使用者的身分呼叫應用程式的 API`
   - **使用者同意顯示名稱：** `Teams 可以以您的身分存取應用程式`
   - **使用者同意描述：** `允許 Teams 以您的身分呼叫應用程式的 API`
   - **狀態：** 已啟用

3. **點擊「**新增範圍**」**

### 步驟 3：授權 Teams 的用戶端應用程式

1. **在「公開 API」頁面中**
   - 找到「**授權的用戶端應用程式**」區塊
   - 點擊「**新增用戶端應用程式**」

2. **新增 Teams 桌面版**
   - **用戶端識別碼：** `1fec8e78-bce4-4aaf-ab1b-5451cc387264`
   - **授權的範圍：** 勾選 `api://teams-sso-test-rho.vercel.app/33abd69a-d012-498a-bddb-8608cbf10c2d/access_as_user`
   - 點擊「**新增應用程式**」

3. **新增 Teams 網頁版**
   - 再次點擊「**新增用戶端應用程式**」
   - **用戶端識別碼：** `5e3ce6c0-2b1f-4285-8d4b-75ef474d30e3`
   - **授權的範圍：** 勾選 `api://teams-sso-test-rho.vercel.app/33abd69a-d012-498a-bddb-8608cbf10c2d/access_as_user`
   - 點擊「**新增應用程式**」

### 步驟 4：確認 API 權限

1. **點擊左側選單的「API 權限」**
2. **確認以下權限都已新增且已獲得管理員同意：**
   - ✅ `User.Read`（Microsoft Graph）
   - ✅ `profile`（Microsoft Graph）
   - ✅ `email`（Microsoft Graph）

3. **如果沒有獲得管理員同意**
   - 點擊「**為 [租用戶名稱] 授與管理員同意**」
   - 確認所有權限都已授與

### 步驟 5：確認驗證設定

1. **點擊左側選單的「驗證」**
2. **確認已新增以下 Redirect URI：**
   - ✅ `https://teams-sso-test-rho.vercel.app`（類型：單頁應用程式）

## 🔄 完成設定後的步驟

### 1. 等待設定生效
- Azure Portal 的設定可能需要 **5-10 分鐘** 才會生效

### 2. 清除 Teams 快取

**桌面版：**
1. 完全關閉 Teams
2. 刪除快取資料夾：
   - Windows: `%appdata%\Microsoft\Teams`
   - Mac: `~/Library/Application Support/Microsoft/Teams`
3. 重新啟動 Teams

**網頁版：**
1. 清除瀏覽器快取和 Cookies
2. 重新載入 Teams

### 3. 重新測試

**桌面版：**
1. 重新啟動 Teams
2. 開啟應用程式
3. 應該會看到 Teams 內建的認證視窗（不是錯誤）
4. 點擊「允許」後，應該可以正常顯示使用者資訊

**網頁版：**
1. 清除快取後重新載入 Teams
2. 開啟應用程式
3. 應該會看到權限要求對話框
4. 點擊「繼續」後，**不應該**重新整理頁面
5. 應該直接顯示使用者資訊

## 🔍 如果仍然有問題

### 檢查控制台日誌

1. **開啟開發者工具**
   - 桌面版：`Ctrl+Shift+I` (Windows) 或 `Cmd+Option+I` (Mac)
   - 網頁版：F12 或右鍵 > 檢查

2. **查看控制台輸出**
   - 應該會看到詳細的日誌
   - 特別注意錯誤代碼和錯誤訊息

3. **記錄錯誤資訊**
   - 複製完整的錯誤訊息
   - 特別注意 `errorCode` 和 `message`

### 常見錯誤代碼

- **`InvalidResource`**: 資源 URI 設定錯誤
  - 解決：檢查應用程式識別碼 URI 是否正確設定

- **`UserConsentRequired`**: 需要使用者授權（正常）
  - 解決：點擊「允許」按鈕

- **`InvalidGrant`**: 授權無效
  - 解決：確認已新增授權的用戶端應用程式

## 📋 快速檢查清單

完成設定後，確認以下項目：

- [ ] 應用程式識別碼 URI 已設定為：`api://teams-sso-test-rho.vercel.app/33abd69a-d012-498a-bddb-8608cbf10c2d`
- [ ] 已新增 `access_as_user` 範圍
- [ ] 已新增 Teams 桌面版用戶端應用程式（`1fec8e78-bce4-4aaf-ab1b-5451cc387264`）
- [ ] 已新增 Teams 網頁版用戶端應用程式（`5e3ce6c0-2b1f-4285-8d4b-75ef474d30e3`）
- [ ] 所有 API 權限都已獲得管理員同意
- [ ] Redirect URI 已正確設定
- [ ] 已清除 Teams 快取
- [ ] 已等待 5-10 分鐘讓設定生效

## 🆘 需要協助？

如果完成所有設定後仍然有問題，請提供：

1. **控制台完整日誌**（從應用程式啟動到錯誤）
2. **錯誤代碼和錯誤訊息**
3. **Azure Portal 設定截圖**（公開 API 頁面）

我可以幫您進一步排查問題。

